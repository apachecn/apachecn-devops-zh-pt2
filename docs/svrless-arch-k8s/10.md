# é™„å½•

å…³äº

åŒ…æ‹¬è¿™ä¸€éƒ¨åˆ†æ˜¯ä¸ºäº†å¸®åŠ©å­¦ç”Ÿå®Œæˆä¹¦ä¸­çš„æ´»åŠ¨ã€‚

å®ƒåŒ…æ‹¬å­¦ç”Ÿä¸ºå®ç°æ´»åŠ¨ç›®æ ‡è€Œè¦æ‰§è¡Œçš„è¯¦ç»†æ­¥éª¤ã€‚

## 1.æ— æœåŠ¡å™¨ç®€ä»‹

### æ´»åŠ¨ 1:ä¼¦æ•¦è‡ªè¡Œè½¦ç§¯åˆ†çš„æ¨ç‰¹æœºå™¨äººåç«¯

**è§£å†³æ–¹æ¡ˆ:**

æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®Œæˆæœ¬æ´»åŠ¨:

1.  Create a **main.go** file for registering function handlers, as in *Exercise 1*.

    è¯¥ä»£ç æ˜¯æ³¨å†Œå‡½æ•°çš„åº”ç”¨çš„å…¥å£ç‚¹ï¼Œä¸»åº”ç”¨å¯åŠ¨:

    ```
    package main
    import (
    Â Â Â "fmt"
    Â Â Â "net/http"
    )
    func main() {
    Â Â Â fmt.Println("Starting the ğŸš² finder..")
    Â Â Â http.HandleFunc("/", FindBikes)
    Â Â Â fmt.Println("Function handlers are registered.")
    Â Â Â http.ListenAndServe(":8080", nil)
    }
    ```

2.  Create a **function.go** file for the **FindBikes** function:

    ```
    ...
    func FindBikes(w http.ResponseWriter, r *http.Request) {
    Â Â Â ...

    Â Â Â // Get bike points for the query
    Â Â Â bikePoints, err := httpClient.Get(fmt.Sprintf(TFL_API_URL + "BikePoint/Search?query=" + url2.QueryEscape(query)))
    Â Â Â ...
    Â Â Â // Get available number of bikes
    Â Â Â availableBikeResponse, err := httpClient.Get(TFL_API_URL + "BikePoint/" + bikePoint.ID)

    ...
    Â Â Â Â Â Â Â Â Â if bikeAmount == 0 {
    Â Â Â Â Â Â Â Â Â Â Â Â w.Write([]byte(fmt.Sprintf(RESPONSE_NO_AVAILABLE_BIKE, bikePoint.CommonName, url)))
    Â Â Â Â Â Â Â Â Â Â Â Â return
    Â Â Â Â Â Â Â Â Â } else {
    Â Â Â Â Â Â Â Â Â Â Â Â w.Write([]byte(fmt.Sprintf(DEFAULT_RESPONSE, bikePoint.CommonName, bikeAmount, url)))
    Â Â Â Â Â Â Â Â Â Â Â Â return
    Â Â Â Â Â Â Â Â Â }
    ...
    ```

    #### æ³¨æ„

    æ´»åŠ¨æ‰€éœ€çš„æ–‡ä»¶å¯åœ¨ä»¥ä¸‹é“¾æ¥ä¸Šæ‰¾åˆ°:https://github . com/trainingyppackt/less-architecture-wit-Kubernetes/tree/master/lesson 01/activity 1ã€‚

    åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œåº”è¯¥å®ç°å®é™…çš„å‡½æ•°åŠå…¶åŠ©æ‰‹ã€‚**æŸ¥æ‰¾è‡ªè¡Œè½¦**è´Ÿè´£ä» **TFL ç»Ÿä¸€åº”ç”¨ç¼–ç¨‹æ¥å£**è·å–è‡ªè¡Œè½¦ç‚¹ä½ç½®çš„æ•°æ®ï¼Œç„¶åè·å–å¯ç”¨è‡ªè¡Œè½¦çš„æ•°é‡ã€‚æ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›å®Œæ•´çš„å¥å­ä½œä¸ºæ¨ç‰¹çš„å›åº”ã€‚

3.  Create a **Dockerfile** for building and packaging the function, as in *Exercise 2*:

    ```
    FROM golang:1.12.5-alpine3.9 AS builder
    ADD . .
    RUN go build *.go
    FROM alpine:3.9
    RUN apk update && apk add ca-certificates && rm -rf /var/cache/apk/*
    RUN update-ca-certificates
    COPY --from=builder /go/function ./bikes
    RUN chmod +x ./bikes
    ENTRYPOINT ["./bikes"]
    ```

    åœ¨è¿™ä¸ª **Dockerfile** ä¸­ï¼Œåº”ç”¨æ„å»ºåœ¨ç¬¬ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œå¹¶æ‰“åŒ…åœ¨ç¬¬äºŒä¸ªå®¹å™¨ä¸­è¿›è¡Œäº¤ä»˜ã€‚

4.  Build the container image with Docker commands: **docker build . -t find-bikes**.

    åº”è¯¥æ˜¯è¿™æ ·çš„:

    ![Figure 1.27: Building the Docker image ](img/C12607_01_27.jpg)

    ###### å›¾ 1.27:æ„å»º Docker æ˜ åƒ

5.  Run the container image as a Docker container and make the ports available on the host system: **docker run -it --rm -p 8080:8080 find-bikes**.

    äº‹æƒ…åº”è¯¥å¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 1.28: Running the Docker container ](img/C12607_01_28.jpg)

    ###### å›¾ 1.28:è¿è¡Œ Docker å®¹å™¨

6.  Test the function's HTTP endpoint with different queries, such as **Oxford**, **Abbey**, or **Diagon Alley**.

    æˆ‘ä»¬æœŸæœ›ä»æ–‡çŒ®ä¸­å¾—åˆ°ä¼¦æ•¦è¡—é“çš„çœŸå®ååº”å’Œæƒ³è±¡è¡—é“çš„å¤±è´¥ååº”:

    ![Figure 1.29: Function responses for different streets ](img/C12607_01_29.jpg)

    ###### å›¾ 1.29:ä¸åŒè¡—é“çš„åŠŸèƒ½å“åº”

7.  Press *Ctrl + C* to exit the container:

    ![Figure 1.30: Exiting the container ](img/C12607_01_30.jpg)

###### å›¾ 1.30:é€€å‡ºå®¹å™¨

## 2ã€‚äº‘ä¸­æ— æœåŠ¡å™¨ç®€ä»‹

### æ´»åŠ¨ 2:æ—¥å¸¸å¤‡ç”¨ä¼šè®®æé†’åŠŸèƒ½

**è§£å†³æ–¹æ¡ˆ**â€“**æ¾å¼›è®¾ç½®:**

1.  In the **Slack** workspace, click on your username and select **Customize Slack**, as shown in the following screenshot:

    ![](img/C12607_02_49.jpg)

    ###### å›¾ 2.49:æ¾å¼›èœå•

2.  Click on **Configure apps** in the open window, as shown in the following screenshot:

    ![](img/C12607_02_50.jpg)

    ###### å›¾ 2.50:æ¾å¼›é…ç½®èœå•

3.  Click on **Browse the App Directory** to add a new application from the directory, as shown in the following screenshot:

    ![Figure 2.51: Slack management   ](img/C12607_02_51.jpg)

    ###### å›¾ 2.51:æ¾å¼›ç®¡ç†

4.  Find **Incoming WebHooks** from the search box in **App Directory**, as shown in the following screenshot:

    ![Figure 2.52: App Directory ](img/C12607_02_52.jpg)

    ###### å›¾ 2.52:åº”ç”¨ç›®å½•

5.  Click on **Add Configuration** for the **Incoming WebHooks** application, as shown in the following screenshot:

    ![Figure 2.53: Incoming Webhooks page ](img/C12607_02_53.jpg)

    ###### å›¾ 2.53:ä¼ å…¥ç½‘ç»œé’©å­é¡µé¢

6.  Fill in the configuration for the incoming webhook by specifying your specific channel name and icon, as shown in the following screenshot:

    ![Figure 2.54: Incoming webhook configuration ](img/C12607_02_54.jpg)

    ###### å›¾ 2.54:ä¼ å…¥çš„ç½‘ç»œé’©å­é…ç½®

    å¤åˆ¶**ç½‘é’©ç½‘å€**ï¼Œç‚¹å‡»**ä¿å­˜è®¾ç½®**ï¼Œå¦‚å‰é¢æˆªå›¾æ‰€ç¤ºã€‚

7.  æ‰“å¼€æˆ‘ä»¬åœ¨æ­¥éª¤ 6 ä¸­æåˆ°çš„ Slack å·¥ä½œåŒºå’Œé€šé“ã€‚æ‚¨å°†çœ‹åˆ°ä¸€æ¡é›†æˆæ¶ˆæ¯:

![Figure 2.55: Integration message in Slack ](img/C12607_02_55.jpg)

###### å›¾ 2.55:Slack ä¸­çš„é›†æˆæ¶ˆæ¯

**æ´»åŠ¨è§£å†³æ–¹æ¡ˆ**

æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®Œæˆæœ¬æ´»åŠ¨:

1.  Create a new function to call the Slack webhook when the function is invoked.

    åœ¨ GCF ä¸­ï¼Œå¯ä»¥ç”¨åç§° **StandupReminder** å®šä¹‰ï¼Œ128 MB å†…å­˜ï¼Œä¸€ä¸ª HTTP è§¦å‘å™¨ã€‚

    è¯¥åŠŸèƒ½å¯ä»¥ç”¨ä»»ä½•æ”¯æŒçš„è¯­è¨€å®ç°ï¼Œå¦‚ **Go 1.11** ï¼Œå¦‚ä¸‹å›¾æˆªå›¾æ‰€ç¤º:

    ![Figure 2.56: Cloud function in Google Cloud Platform ](img/C12607_02_56.jpg)

    ###### å›¾ 2.56:è°·æ­Œäº‘å¹³å°ä¸­çš„äº‘åŠŸèƒ½

    è¦æ·»åŠ çš„ä»£ç å¦‚ä¸‹:

    ```
    package p
    import (
    Â Â Â Â "bytes"
    Â Â Â Â "net/http"
    )
    func Reminder(http.ResponseWriter, *http.Request) {
    Â Â Â Â url := "https://hooks.slack.com/services/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"

    Â Â Â Â var jsonStr = []byte(`{"text": "Time for a stand-up meeting!"}`)
    Â Â Â Â req, err := http.NewRequest("POST", url, bytes.NewBuffer(jsonStr))

    Â Â Â Â client := &http.Client{}
    Â Â Â Â _, err = client.Do(req)
    Â Â Â Â if err != nil {
    Â Â Â Â Â Â Â Â panic(err)
    Â Â Â Â }
    }
    ```

    #### æ³¨æ„

    ä¸è¦å¿˜è®°ä»ç¬¬ 6 æ­¥å¼€å§‹ï¼Œä¸ºä¼ å…¥çš„ webhook é…ç½®ç”¨ Slack URL æ›´æ”¹ **url** å€¼ã€‚

    ä½ å¯ä»¥åœ¨æœ¬ä¹¦ GitHub èµ„æºåº“çš„æ´»åŠ¨è§£å†³æ–¹æ¡ˆä¸­æ‰¾åˆ°å®Œæ•´çš„ **function.go** æ–‡ä»¶:[https://GitHub . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 02/activity 2/function . go](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson02/Activity2/function.go)ã€‚

2.  Create a scheduler job with the trigger URL of the function and specify the schedule based on your stand-up meeting times.

    è°ƒåº¦å™¨å¯ä»¥åœ¨è°·æ­Œäº‘è°ƒåº¦å™¨ä¸­å®šä¹‰ï¼Œåç§°ä¸º **StartupReminder** å’Œå‡½æ•°çš„ URLï¼Œå¦‚ä¸‹å›¾æˆªå›¾æ‰€ç¤º:

    ![Figure 2.57: Cloud scheduler in Google Cloud Platform ](img/C12607_02_57.jpg)

    ###### å›¾ 2.57:è°·æ­Œäº‘å¹³å°ä¸­çš„äº‘è°ƒåº¦å™¨

    æŒ‰ç…§ **0 9 * * 1-5** çš„æ—¶é—´è¡¨ï¼Œæé†’å°†åœ¨å‘¨ä¸€è‡³å‘¨äº”çš„æ¯ä¸€å¤©çš„ 09:00 è°ƒç”¨è¯¥åŠŸèƒ½ã€‚

3.  Check the Slack channel when the time that was defined with the schedule has arrived for the reminder message.

    å¯¹äº **0 9 * * 1-5** çš„æ—¥ç¨‹å®‰æ’ï¼Œæ‚¨å°†åœ¨å·¥ä½œæ—¥çš„ 09:00 åœ¨æ‚¨é€‰æ‹©çš„ Slack é¢‘é“ä¸Šçœ‹åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚ä¸‹æˆªå›¾æ‰€ç¤º:

    ![Figure 2.58: Slack reminder message  ](img/C12607_02_58.jpg)

    ###### å›¾ 2.58:æ¾å¼›æé†’æ¶ˆæ¯

4.  Delete the schedule job and function from the cloud provider, as shown in the following screenshot:

    ![Figure 2.59: Deletion of the scheduler ](img/C12607_02_59.jpg)

###### å›¾ 2.59:åˆ é™¤è°ƒåº¦ç¨‹åº

è¯¥åŠŸèƒ½å¯ä»¥è¿™æ ·åˆ é™¤:

![Figure 2.60: Deletion of the function ](img/C12607_02_60.jpg)

###### å›¾ 2.60:åˆ é™¤åŠŸèƒ½

åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å‡½æ•°æ„å»ºäº† Slack åº”ç”¨çš„åç«¯ã€‚æˆ‘ä»¬é¦–å…ˆä¸ºä¼ å…¥çš„ webhook é…ç½® Slackï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå‡½æ•°å‘ web hook å‘é€æ•°æ®ã€‚å› ä¸ºæˆ‘ä»¬çš„å‡½æ•°åº”è¯¥åœ¨é¢„å®šä¹‰çš„æ—¶é—´è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨äº‘è°ƒåº¦æœåŠ¡æ¥è°ƒç”¨å‡½æ•°ã€‚é€šè¿‡ Slack ä¸­çš„ä¸€æ¡æˆåŠŸçš„æé†’æ¶ˆæ¯ï¼Œå±•ç¤ºäº†åŠŸèƒ½ä¸å…¶ä»–äº‘æœåŠ¡å’Œå¤–éƒ¨æœåŠ¡çš„é›†æˆã€‚

## 3ã€‚æ— æœåŠ¡å™¨æ¡†æ¶ä»‹ç»

### æ´»åŠ¨ 3:æ¾å¼›çŠ¶æ€çš„æ¯æ—¥å¤©æ°”çŠ¶æ€åŠŸèƒ½

**è§£å†³æ–¹æ¡ˆ-æ¾å¼›è®¾ç½®**

1.  æ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥é…ç½®æ¾å¼›æ—¶é—´:
2.  In your Slack workspace, click on your username and select Customize Slack:

    ![Figure 3.44: Slack menu ](img/C12607_03_44.jpg)

    ###### å›¾ 3.44:æ¾å¼›èœå•

3.  Click on Configure apps in the opened window:

    ![Figure 3.45: Slack configuration menu ](img/C12607_03_45.jpg)

    ###### å›¾ 3.45:æ¾å¼›é…ç½®èœå•

4.  Click on Browse the App Directory to add a new application from the directory:

    ![Figure 3.46: Slack management ](img/C12607_03_46.jpg)

    ###### å›¾ 3.46:æ¾å¼›ç®¡ç†

5.  Find Incoming WebHooks from the search box in App Directory:

    ![Figure 3.47: App Directory ](img/C12607_03_47.jpg)

    ###### å›¾ 3.47:åº”ç”¨ç›®å½•

6.  Click on Set Up for the Incoming WebHooks application:

    ![Figure 3.48: Incoming WebHooks page ](img/C12607_03_48.jpg)

    ###### å›¾ 3.48:ä¼ å…¥çš„ç½‘ç»œæŒ‚é’©é¡µé¢

7.  Choose a channel for posting joke messages and click on the Add Incoming WebHooks integration:

    ![Figure 3.49: Channel selection  ](img/C12607_03_49.jpg)

    ###### å›¾ 3.49:é¢‘é“é€‰æ‹©

8.  Fill in the configuration for the incoming webhook with your specific channel name and icon:

    ![Figure 3.50: Incoming WebHook configuration ](img/C12607_03_50.jpg)

    ###### å›¾ 3.50:ä¼ å…¥çš„ç½‘ç»œé’©å­é…ç½®

    å¤åˆ¶ç½‘é¡µæŒ‚é’©ç½‘å€ï¼Œç„¶åå•å‡»ä¿å­˜è®¾ç½®ã€‚

9.  Open your Slack workspace and the channel you configured in Step 6 to check the integration message:

    ![Figure 3.51: Integration message in Slack ](img/C12607_03_51.jpg)

###### å›¾ 3.51:Slack ä¸­çš„é›†æˆæ¶ˆæ¯

**æ´»åŠ¨è§£å†³æ–¹æ¡ˆ**

1.  æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®Œæˆæœ¬æ´»åŠ¨:
2.  In your Terminal, start the Serverless Framework development environment:

    ```
    docker run -it --entrypoint=bash onuryilmaz/serverless
    ```

    è¯¥å‘½ä»¤å°†ä»¥äº¤äº’æ¨¡å¼å¯åŠ¨ Docker å®¹å™¨ã€‚åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­ï¼Œå°†åœ¨è¿™ä¸ª Docker å®¹å™¨ä¸­é‡‡å–æ“ä½œ:

    ![Figure 3.52: Starting a Docker container for serverless  ](img/C12607_03_52.jpg)

    ###### å›¾ 3.52:ä¸ºæ— æœåŠ¡å™¨å¯åŠ¨ Docker å®¹å™¨

3.  In your Terminal, create a Serverless Framework application structure in a folder called daily-weather.

    åˆ›å»ºä¸€ä¸ªåä¸º daily-joker çš„æ–‡ä»¶å¤¹ï¼Œå¹¶å°†å…¶æ›´æ”¹ä¸ºä»¥ä¸‹ç›®å½•:

    ```
    mkdir daily-weather
    cd daily-weather
    ```

    #### æ³¨æ„

    nano å’Œ vim ä½œä¸ºæ–‡æœ¬ç¼–è¾‘å™¨å®‰è£…åœ¨æ— æœåŠ¡å™¨æ¡†æ¶å¼€å‘ç¯å¢ƒ Docker å®¹å™¨ä¸­ã€‚

4.  Create a serverless.yaml file with the following content and replace the value of SLACK_WEBHOOK_URL with the URL you copied from Step 6 of the Slack Setup. Furthermore, update the CITY environment variable with the current office location to get the correct weather information. In addition, you can change the schedule section, which is currently triggering the function every workday at 08:00:

    ```
    service: daily-weather
    provider:
    Â Â name: aws
    Â Â runtime: nodejs8.10
    functions:
    Â Â weather:
    Â Â Â Â handler: handler.weather
    Â Â Â Â events:
    Â Â Â Â Â Â - schedule: cron(0 8 ? * 1-5 *)
    Â Â Â Â environment:
    Â Â Â Â Â Â CITY: Berlin
    Â Â Â Â Â Â SLACK_WEBHOOK_URL: https://hooks.slack.com/services/.../.../...
    ```

    #### æ³¨æ„

    æ— æœåŠ¡å™¨. yaml å¯åœ¨[https://github . com/trainingypbackt/æ— æœåŠ¡å™¨-architecture-with-Kubernetes/blob/master/lesson 03/activity 3/æ— æœåŠ¡å™¨. yaml](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson03/Activity3/serverless.yaml) è·å¾—ã€‚

5.  Create a package.json file to define the Node.js environment in the daily-weather folder.

    package.json å®šä¹‰äº†å‡½æ•°åŠå…¶ä¾èµ–å…³ç³»:

    ```
    {
    Â Â "name": "daily-weather",
    Â Â "description": "",
    Â Â "main": "handler.js",
    Â Â Â Â "dependencies": {
    Â Â Â Â "node-fetch": "^2.2.1",
    Â Â Â Â "slack-node": "0.1.8"
    Â Â }
    }
    ```

    #### æ³¨æ„

    package.json å¯åœ¨[https://github . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 03/activity 3/package . JSON](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson03/Activity3/package.json)è·å¾—ã€‚

6.  Create a handler.js file to implement the actual functionality in the daily-weather folder.

    handler.js ç”±å®é™…çš„ Node.js å‡½æ•°ç»„æˆ:

    ```
    const fetch = require('node-fetch');
    const Slack = require('slack-node');
    module.exports.weather = (event, context, callback) => {
    Â Â Â Â const webhookUri = process.env.SLACK_WEBHOOK_URL;
    Â Â Â Â const location = process.env.CITY;
    Â Â Â Â const slack = new Slack();
    Â Â Â Â slack.setWebhook(webhookUri);
    Â Â Â Â weatherURL = "http://wttr.in/" + encodeURIComponent(location) + "?m&&format=1"
    Â Â Â Â console.log(weatherURL)
    Â Â Â Â fetch(weatherURL)
    Â Â Â Â Â Â Â Â .then(response => response.text())
    Â Â Â Â Â Â Â Â .then(data => {
    Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== WEATHER TEXT ========")
    Â Â Â Â Â Â Â Â Â Â Â Â console.error(data);
    Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== WEATHER TEXT ========")
    Â Â Â Â Â Â Â Â Â Â Â Â slack.webhook({
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â text: "Current weather status is " + data
    Â Â Â Â Â Â Â Â Â Â Â Â }, function(err, response) {
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== SLACK SEND STATUS ========")
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error(response.status);
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return callback(null, {statusCode: 200, body: "ok" });
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== SLACK SEND STATUS ========")
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (err) {
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== ERROR ========")
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error(error);
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== ERROR ========")
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return callback(null, {statusCode: 500, body: JSON.stringify({ error}) });
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
    Â Â Â Â Â Â Â Â Â Â Â Â });
    Â Â Â Â Â Â Â Â }).catch((error) => {
    Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== ERROR ========")
    Â Â Â Â Â Â Â Â Â Â Â Â console.error(error);
    Â Â Â Â Â Â Â Â Â Â Â Â console.log("======== ERROR ========")
    Â Â Â Â Â Â Â Â Â Â Â Â Â return callback(null, {statusCode: 500, body: JSON.stringify({ error}) });
    Â Â Â Â Â Â Â Â });
    };
    ```

    #### æ³¨æ„

    handler.js å¯åœ¨[https://github . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 03/activity 3/handler . js](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson03/Activity3/handler.js)è·å¾—ã€‚

7.  At the end of the file's creation, you will see the following file structure, with three files:

    ```
    ls -l
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 3.53: Folder structure ](img/C12607_03_53.jpg)

    ###### å›¾ 3.53:æ–‡ä»¶å¤¹ç»“æ„

8.  Install the required Node.js dependencies for the serverless application. Run the following command to install the dependencies:

    ```
    npm install -i
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 3.54: Dependency installation  ](img/C12607_03_54.jpg)

    ###### å›¾ 3.54:ä¾èµ–é¡¹å®‰è£…

9.  Export the AWS credentials as environment variables. Export the following environment variables and AWS credentials from Exercise xx:

    ```
    export AWS_ACCESS_KEY_ID=AKIASVTPHRZR33BS256U
    export AWS_SECRET_ACCESS_KEY=B***************************R
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 3.55: AWS Credentials ](img/C12607_03_55.jpg)

    ###### å›¾ 3.55:è‡ªåŠ¨æ°”è±¡ç«™å‡­è¯

10.  Deploy the serverless application to AWS using the Serverless Framework. Run the following commands to deploy the function:

    ```
    serverless deploy 
    ```

    è¿™äº›å‘½ä»¤å°†ä½¿æ— æœåŠ¡å™¨æ¡†æ¶å°†è¯¥åŠŸèƒ½éƒ¨ç½²åˆ° AWS ä¸­ã€‚è¾“å‡ºæ—¥å¿—ä»æ‰“åŒ…æœåŠ¡å’Œä¸ºæºä»£ç ã€å·¥ä»¶å’Œå‡½æ•°åˆ›å»º AWS èµ„æºå¼€å§‹ã€‚åˆ›å»ºå®Œæ‰€æœ‰èµ„æºåï¼ŒæœåŠ¡ä¿¡æ¯éƒ¨åˆ†æä¾›äº†å®Œæ•´å †æ ˆçš„æ‘˜è¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 3.56: Serverless Framework deployment output ](img/C12607_03_56.jpg)

    ###### å›¾ 3.56:æ— æœåŠ¡å™¨æ¡†æ¶éƒ¨ç½²è¾“å‡º

11.  Check AWS Lambda for the deployed functions in the AWS Console as shown in the following figure:

    ![Figure 3.57: AWS Lambda in the AWS Console ](img/C12607_03_57.jpg)

    ###### å›¾ 3.57: AWS æ§åˆ¶å°ä¸­çš„ AWS Lambda

12.  Invoke the function with the Serverless Framework's client tools. Run the following command in your Terminal:

    ```
    serverless invoke --function weather
    ```

    è¯¥å‘½ä»¤è°ƒç”¨éƒ¨ç½²çš„å‡½æ•°å¹¶è¾“å‡ºå“åº”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 3.58: Function output  ](img/C12607_03_58.jpg)

    ###### å›¾ 3.58:åŠŸèƒ½è¾“å‡º

    æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒstatusCode ä¸º 200ï¼Œå“åº”çš„ä¸»ä½“ä¹Ÿè¡¨ç¤ºå‡½æ•°å·²ç»æˆåŠŸå“åº”ã€‚

13.  Check the Slack channel for the posted weather status:

    ![FFigure 3.59: Slack message with weather status ](img/C12607_03_59.jpg)

    ###### å›¾ 3.59:å¸¦æœ‰å¤©æ°”çŠ¶æ€çš„æ¾å¼›æ¶ˆæ¯

14.  Return to your Terminal and delete the function with the Serverless Framework. Run the following command in your Terminal:

    ```
    serverless remove
    ```

    è¯¥å‘½ä»¤å°†åˆ é™¤å·²éƒ¨ç½²çš„å‡½æ•°åŠå…¶æ‰€æœ‰ä¾èµ–é¡¹:

    ![Figure 3.60: Removing the function ](img/C12607_03_60.jpg)

    ###### å›¾ 3.60:åˆ é™¤åŠŸèƒ½

15.  Exit the Serverless Framework development environment container. Run exit in your Terminal:

    ![Figure 3.61: Exiting the container  ](img/C12607_03_61.jpg)

###### å›¾ 3.61:é€€å‡ºå®¹å™¨

åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ— æœåŠ¡å™¨æ¡†æ¶æ„å»ºäº† Slack åº”ç”¨çš„åç«¯ã€‚æˆ‘ä»¬é¦–å…ˆä¸ºä¼ å…¥çš„ webhook é…ç½® Slackï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ— æœåŠ¡å™¨åº”ç”¨å°†æ•°æ®å‘é€åˆ° web hookã€‚ä¸ºäº†åœ¨é¢„å®šä¹‰çš„æ—¶é—´è°ƒç”¨è¯¥åŠŸèƒ½ï¼Œä½¿ç”¨äº†æ— æœåŠ¡å™¨æ¡†æ¶çš„é…ç½®ï¼Œè€Œä¸æ˜¯ç‰¹å®šäºäº‘çš„è°ƒåº¦å™¨ã€‚ç”±äºæ— æœåŠ¡å™¨æ¡†æ¶ä¸ºäº‘æä¾›å•†åˆ›å»ºäº†ä¸€ä¸ªæŠ½è±¡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æœ¬ç»ƒä¹ ä¸­å¼€å‘çš„æ— æœåŠ¡å™¨åº”ç”¨é€‚ç”¨äºå¤šäº‘éƒ¨ç½²ã€‚

## 4.Kubernetesæ·±ç©ºçš„æ²™å‘

### æ´»åŠ¨ 4:åœ¨ Kubernetes çš„ MySQL æ•°æ®åº“ä¸­æ”¶é›†é»„é‡‘ä»·æ ¼

**è§£å†³æ–¹æ¡ˆ:**

æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®Œæˆæœ¬æ´»åŠ¨:

1.  Create an application to retrieve the gold price from **CurrencyLayer** and insert it into the MySQL database.

    å¯ä»¥ç”¨ä¸‹é¢çš„ main.go æ–‡ä»¶åœ¨ Go ä¸­å®ç°è¿™ä¸ªåŠŸèƒ½:

    ```
    ...
    func main() {
    Â Â Â Â db, err := sql.Open("mysql",Â Â ...
    Â Â Â Â ...
    Â Â Â Â r, err := http.Get(fmt.Sprintf(â€http://apilayer.net/api/...
    Â Â Â ...
    Â Â Â Â stmt, err := db.Prepare("INSERT INTO GoldPrices(price) VALUES(?)")
    Â Â Â Â ...
    Â Â Â Â _, err = stmt.Exec(target.Quotes.USDXAU)
    Â Â Â Â ...
    Â Â Â Â log.Printf("Successfully inserted the price: %v", target.Quotes.USDXAU)
    Â Â Â Â ...
    }
    ```

    ä¸»è¦åŠŸèƒ½ä»æ•°æ®åº“è¿æ¥å¼€å§‹ï¼Œç„¶åä»**current layer**è¿›è¡Œä»·æ ¼æ£€ç´¢ã€‚ç„¶åï¼Œå®ƒç»§ç»­åˆ›å»ºä¸€æ¡ SQL è¯­å¥ï¼Œå¹¶åœ¨æ•°æ®åº“è¿æ¥ä¸Šæ‰§è¡Œã€‚

    #### æ³¨æ„

    main.go å¯åœ¨[https://github . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 04/activity 4/main . go](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson04/Activity4/main.go)ä¸Šè·å¾—ã€‚

2.  Build the application as a Docker container. It is possible to build the application from Step 1 with the following Dockerfile:

    ```
    FROM golang:1.12.5-alpine3.9 AS builder
    RUN apk add --no-cache git
    ADD main.go /go/src/gold-price-to-mysql/main.go
    WORKDIR /go/src/gold-price-to-mysql/
    RUN go get -v
    RUN go build .
    FROM alpine:3.9
    COPY --from=builder /go/src/gold-price-to-mysql/gold-price-to-mysql ./gold-price-to-mysql
    RUN chmod +x ./gold-price-to-mysql
    ENTRYPOINT ["./gold-price-to-mysql"]
    ```

    #### æ³¨æ„

    Dockerfile å¯åœ¨[https://github . com/trainingypbackt/server less-architecture-with-Kubernetes/blob/master/lesson 04/activity 4/docker file](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson04/Activity4/Dockerfile)ä¸Šè·å¾—ã€‚

3.  Run the following command in your Terminal:

    ```
    docker build -t <USERNAME>/gold-price-to-mysql .
    ```

    è¯¥å‘½ä»¤å°†åº”ç”¨æ„å»ºä¸º Docker å®¹å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.26: Docker build ](img/C12607_04_26.jpg)

    ###### å›¾ 4.26: Docker æ„å»º

    #### æ³¨æ„

    ä¸è¦å¿˜è®°å°† **<ç”¨æˆ·å>** æ›´æ”¹ä¸ºæ‚¨çš„ç å¤´å·¥äººä¸­å¿ƒç”¨æˆ·åã€‚

4.  Push the Docker container to the Docker registry. Run the following command in your Terminal:

    ```
    docker push <USERNAME>/gold-price-to-mysql
    ```

    è¯¥å‘½ä»¤å°†å®¹å™¨æ˜ åƒä¸Šä¼ åˆ° Docker Hubï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.27: Docker push ](img/C12607_04_27.jpg)

    ###### å›¾ 4.27: Docker æ¨é€

    #### æ³¨æ„

    ä¸è¦å¿˜è®°å°† **<ç”¨æˆ·å>** æ›´æ”¹ä¸ºæ‚¨çš„ç å¤´å·¥äººä¸­å¿ƒç”¨æˆ·åã€‚

5.  Deploy the MySQL database into the Kubernetes cluster. Create a mysql.yaml file with the MySQL StatefulSet definition:

    ```
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
    Â Â name: mysql
    spec:
    Â Â selector:
    Â Â Â Â matchLabels:
    Â Â Â Â Â Â app: mysql
    Â Â serviceName: mysql
    Â Â replicas: 1
    Â Â template:
    Â Â Â Â metadata:
    Â Â Â Â Â Â labels:
    Â Â Â Â Â Â Â Â app: mysql
    Â Â Â Â spec:
    Â Â Â Â Â Â containers:
    Â Â Â Â Â Â - name: mysql
    Â Â Â Â Â Â Â Â image: mysql:5.7
    Â Â Â Â Â Â Â Â env:
    Â Â Â Â Â Â Â Â - name: MYSQL_ROOT_PASSWORD
    Â Â Â Â Â Â Â Â Â Â value: "root"
    Â Â Â Â Â Â Â Â - name: MYSQL_DATABASE
    Â Â Â Â Â Â Â Â Â Â value: "db"
    Â Â Â Â Â Â Â Â - name: MYSQL_USER
    Â Â Â Â Â Â Â Â Â Â value: "user"
    Â Â Â Â Â Â Â Â - name: MYSQL_PASSWORD
    Â Â Â Â Â Â Â Â Â Â value: "password"
    Â Â Â Â Â Â Â Â ports:
    Â Â Â Â Â Â Â Â - name: mysql
    Â Â Â Â Â Â Â Â Â Â containerPort: 3306
    Â Â Â Â Â Â Â Â volumeMounts:
    Â Â Â Â Â Â Â Â - name: data
    Â Â Â Â Â Â Â Â Â Â mountPath: /var/lib/mysql
    Â Â Â Â Â Â Â Â Â Â subPath: mysql
    Â Â volumeClaimTemplates:
    Â Â - metadata:
    Â Â Â Â Â Â name: data
    Â Â Â Â spec:
    Â Â Â Â Â Â accessModes: ["ReadWriteOnce"]
    Â Â Â Â Â Â resources:
    Â Â Â Â Â Â Â Â requests:
    Â Â Â Â Â Â Â Â Â Â storage: 1Gi
    ```

    #### æ³¨æ„

    mysql.yaml å¯åœ¨[https://github . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 04/activity 4/MySQL . YAML](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson04/Activity4/mysql.yaml)ä¸Šè·å¾—ã€‚

6.  Deploy the StatefulSet with the following command in your Terminal:

    ```
    kubectl apply -f mysql.yaml
    ```

    è¯¥å‘½ä»¤å°†æ–‡ä»¶æäº¤ç»™ Kubernetes å¹¶åˆ›å»º mysql StatefulSetï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.28: StatefulSet creation ](img/C12607_04_28.jpg)

    ###### å›¾ 4.28:çŠ¶æ€é›†åˆåˆ›å»º

7.  Deploy a Kubernetes service to expose MySQL database. Create a service.yaml file with the following Kubernetes Service definition:

    ```
    apiVersion: v1
    kind: Service
    metadata:
    Â Â name: gold-price-db
    spec:
    Â Â selector:
    Â Â Â Â app: mysql
    Â Â ports:
    Â Â Â Â - protocol: TCP
    Â Â Â Â Â Â port: 3306
    Â Â Â Â Â Â targetPort: 3306
    ```

    #### æ³¨æ„

    service.yaml å¯åœ¨[https://github . com/trainingypbackt/server less-Architectures-with-Kubernetes/blob/master/lesson 04/activity 4/service . YAML](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson04/Activity4/service.yaml)è·å¾—ã€‚

8.  Deploy the service with the following command in your Terminal:

    ```
    kubectl apply -f service.yaml
    ```

    è¯¥å‘½ä»¤å°†æ–‡ä»¶æäº¤ç»™ Kubernetes å¹¶åˆ›å»º gold-price-db æœåŠ¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.29: Service creation ](img/C12607_04_29.jpg)

    ###### å›¾ 4.29:æœåŠ¡åˆ›å»º

9.  Deploy a CronJob to run every minute. Create an insert-gold-price.yaml file with the following Kubernetes CronJob definition:

    ```
    apiVersion: batch/v1beta1
    kind: CronJob
    metadata:
    Â Â name: gold-price-to-mysql
    spec:
    Â Â schedule: "* * * * *"
    Â Â jobTemplate:
    Â Â Â Â spec:
    Â Â Â Â Â Â template:
    Â Â Â Â Â Â Â Â spec:
    Â Â Â Â Â Â Â Â Â Â restartPolicy: OnFailure
    Â Â Â Â Â Â Â Â Â Â containers:
    Â Â Â Â Â Â Â Â Â Â - name: insert
    Â Â Â Â Â Â Â Â Â Â Â Â image: <USERNAME>/gold-price-to-mysql
    Â Â Â Â Â Â Â Â Â Â Â Â env:
    Â Â Â Â Â Â Â Â Â Â Â Â - name: MYSQL_ADDRESS
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â value: "gold-price-db:3306"
    Â Â Â Â Â Â Â Â Â Â Â Â - name: MYSQL_DATABASE
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â value: "db"
    Â Â Â Â Â Â Â Â Â Â Â Â - name: MYSQL_USER
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â value: "user"
    Â Â Â Â Â Â Â Â Â Â Â Â - name: MYSQL_PASSWORD
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â value: "password"
    Â Â Â Â Â Â Â Â Â Â Â Â - name: API_KEY
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â value: "<API-KEY>"
    ```

    #### æ³¨æ„

    insert-gold-price.yaml å¯åœ¨[https://github . com/trainingypbackt/server less-architecture-with-Kubernetes/blob/master/lesson 04/activity 4/insert-gold-price . YAML](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson04/Activity4/insert-gold-price.yaml)è·å¾—ã€‚

    ä¸è¦å¿˜è®°å°† **<ç”¨æˆ·å>** æ›´æ”¹ä¸ºæ‚¨çš„ Docker Hub ç”¨æˆ·åï¼Œå¹¶å°†**T6ã€‘API-KEY>**æ›´æ”¹ä¸ºæ‚¨å½“å‰çš„å›¾å±‚ API å¯†é’¥ã€‚

10.  Deploy the CronJob with the following command in your Terminal:

    ```
    kubectl apply -f insert-gold-price.yaml
    ```

    è¯¥å‘½ä»¤å°†æ–‡ä»¶æäº¤ç»™ Kubernetesï¼Œå¹¶åˆ›å»ºé»„é‡‘ä»·æ ¼åˆ° mysql çš„ CronJobï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.30: CronJob creation ](img/C12607_04_30.jpg)

    ###### å›¾ 4.30:åˆ›å»ºæ ¸å¿ƒå·¥ä½œ

11.  Wait for a couple of minutes and check the instances of CronJob. Check the running pods with the following command in your Terminal:

    ```
    kubectl get pods
    ```

    è¯¥å‘½ä»¤åˆ—å‡ºäº† podsï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸¤ä¸ªå®ä¾‹ï¼Œå®ƒä»¬çš„åç§°ä»¥é»„é‡‘ä»·æ ¼åˆ° mysql å¼€å¤´ï¼ŒçŠ¶æ€ä¸ºâ€œå·²å®Œæˆâ€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.31: Pod listing ](img/C12607_04_31.jpg)

    ###### å›¾ 4.31: Pod åˆ—è¡¨

12.  Connect to the database and check for the entries:

    ```
    kubectl run mysql-client --image=mysql:5.7 -i -t --rm --restart=Never \
    -- mysql -h gold-price-db -u user -ppasswordÂ Â db -e "SELECT * FROM GoldPrices;"
    ```

    æ­¤å‘½ä»¤è¿è¡Œ mysql:5.7 æ˜ åƒçš„ä¸´æ—¶å®ä¾‹ï¼Œå¹¶è¿è¡Œ SELECT * FROM GoldPrices å‘½ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 4.32: Table listing ](img/C12607_04_32.jpg)

    ###### å›¾ 4.32:è¡¨æ ¼åˆ—è¡¨

    åœ¨ GoldPrices MySQL è¡¨ä¸­ï¼Œæ¯åˆ†é’Ÿéƒ½æœ‰æ”¶é›†åˆ°çš„ä»·æ ¼æ•°æ®ã€‚å®ƒæ˜¾ç¤º MySQL StatefulSet å·²å¯åŠ¨å¹¶æˆåŠŸè¿è¡Œæ•°æ®åº“ã€‚æ­¤å¤–ï¼ŒCronJob æ¯åˆ†é’Ÿéƒ½åœ¨åˆ›å»º podsï¼Œå¹¶ä¸”æ­£åœ¨æˆåŠŸè¿è¡Œã€‚

13.  Clean the database and automated tasks from Kubernetes. Clean the resources with the following command in your Terminal:

    ```
    kubectl delete -f insert-gold-price.yaml,service.yaml,mysql.yaml
    ```

    æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸‹å›¾æ‰€ç¤ºçš„è¾“å‡º:

    ![Figure 4.33: Resource deletion ](img/C12607_04_33.jpg)

###### å›¾ 4.33:èµ„æºåˆ é™¤

åœ¨æœ¬æ´»åŠ¨ä¸­ï¼Œæˆ‘ä»¬åœ¨ Kubernetes ä¸­åˆ›å»ºäº†ä¸€ä¸ª MySQL æ•°æ®åº“ä½œä¸º StatefulSetã€‚Kubernetes å·²ç»åˆ›å»ºäº†æ‰€éœ€çš„å·èµ„æºï¼Œå¹¶é™„åŠ åˆ° MySQL å®¹å™¨ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºå¹¶æ‰“åŒ…äº†æˆ‘ä»¬çš„æ— æœåŠ¡å™¨å‡½æ•°ã€‚è¯¥åŠŸèƒ½ä½œä¸º CronJob éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚Kubernetes ç¡®ä¿è¯¥åŠŸèƒ½æ¯åˆ†é’Ÿéƒ½è¢«å®‰æ’å’Œè¿è¡Œã€‚åœ¨ Kubernetes ä¸­è¿è¡Œå‡½æ•°æä¾›äº†ä¸¤ä¸ªåŸºæœ¬ä¼˜åŠ¿ã€‚ç¬¬ä¸€ä¸ªæ˜¯ Kubernetes é›†ç¾¤å’Œèµ„æºçš„é‡ç”¨ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ä»»ä½•é¢å¤–çš„äº‘èµ„æºæ¥è¿è¡Œæˆ‘ä»¬çš„æ— æœåŠ¡å™¨å·¥ä½œè´Ÿè½½ã€‚ç¬¬äºŒä¸ªä¼˜åŠ¿æ˜¯æ¥è¿‘æ•°æ®ã€‚ç”±äºæˆ‘ä»¬çš„å¾®æœåŠ¡å·²ç»åœ¨ Kubernetes ä¸Šè¿è¡Œï¼Œå»ºè®®å°†æˆ‘ä»¬çš„æ•°æ®åº“æ”¾åœ¨ Kubernetes ä¸­ã€‚å½“æ— æœåŠ¡å™¨åº”ç”¨ä¹Ÿåœ¨åŒä¸€ä¸ªç¾¤é›†ä¸­è¿è¡Œæ—¶ï¼Œæ“ä½œã€ç®¡ç†å’Œæ’é™¤åº”ç”¨æ•…éšœä¼šæ›´å®¹æ˜“ã€‚

## 5.ç”Ÿäº§å°±ç»ªåº“ç¾¤é›†

### æ´»åŠ¨ 5:æœ€å°åŒ– GKE é›†ç¾¤ä¸­æ— æœåŠ¡å™¨åŠŸèƒ½çš„æˆæœ¬

**è§£å†³æ–¹æ¡ˆ**

1.  Create a new node pool with preemptible servers.

    åœ¨æ‚¨çš„ GCP äº‘å¤–å£³ä¸­è¿è¡Œä»¥ä¸‹å’Œå³å°†åˆ°æ¥çš„åŠŸèƒ½:

    ```
    gcloud beta container node-pools create preemptible --preemptible \
    --min-nodes 1 --max-nodes 10Â Â --enable-autoscalingÂ Â \
    --cluster serverless --zone us-central1-a 
    ```

    #### æ³¨æ„

    å¦‚æœæ‚¨çš„é›†ç¾¤åœ¨å¦ä¸€ä¸ªåŒºåŸŸè¿è¡Œï¼Œè¯·æ›´æ”¹**åŒºåŸŸ**å‚æ•°ã€‚

    è¯¥å‡½æ•°åˆ›å»ºä¸€ä¸ªåä¸º**çš„å¯æŠ¢å **çš„æ–°èŠ‚ç‚¹æ± ï¼Œè¯¥èŠ‚ç‚¹æ± è‡ªåŠ¨ç¼©æ”¾æœ€å° 1 ä¸ªèŠ‚ç‚¹ï¼Œæœ€å¤§ 10 ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.29: Node pool creation ](img/C12607_05_29.jpg)

    ###### å›¾ 5.29:èŠ‚ç‚¹æ± åˆ›å»º

2.  Taint the preemptible servers to run only serverless functions:

    ```
    kubectl taint node -l cloud.google.com/gke-nodepool=preemptibleÂ Â Â \
    preemptible="true":NoSchedule
    ```

    è¯¥å‘½ä»¤å°†æŠŠæ±¡ç‚¹åº”ç”¨åˆ°æ ‡ç­¾ä¸º**cloud.google.com/node-pool =å¯æŠ¢å **çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚æ±¡ç‚¹é”®å°†æ˜¯**å¯æŠ¢å çš„**ï¼Œå€¼ä¸º**çœŸ**ã€‚è¯¥é™åˆ¶çš„åŠ¨ä½œä¸º**æ— è°ƒåº¦**ï¼Œè¿™æ„å‘³ç€åªæœ‰å…·æœ‰åŒ¹é…å®¹å¿åº¦çš„åŠèˆ±æ‰ä¼šè¢«è°ƒåº¦åˆ°è¿™äº›èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.30: Tainting the nodes ](img/C12607_05_30.jpg)

    ###### å›¾ 5.30:æ±¡æŸ“èŠ‚ç‚¹

3.  Create a Kubernetes service to reach backend pods:

    ```
    kubectl expose deployment backend --port 80 --target-port=80
    ```

    è¯¥å‘½ä»¤ä¸ºç«¯å£ **80** ä¸Šçš„éƒ¨ç½²åç«¯åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.31: Exposing the deployment ](img/C12607_05_31.jpg)

    ###### å›¾ 5.31:å…¬å¼€éƒ¨ç½²

4.  Create a **CronJob** to connect to the backend service every minute. The CronJob definition should have tolerations to run on preemptible servers.

    åœ¨åä¸º **cronjob.yaml** çš„æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„ **CronJob** å®šä¹‰:

    ```
    apiVersion: batch/v1beta1
    kind: CronJob
    metadata:
    Â Â name: backend-checker
    spec:
    Â Â schedule: "*/1 * * * *"
    Â Â jobTemplate:
    Â Â Â Â spec:
    Â Â Â Â Â Â template:
    Â Â Â Â Â Â Â Â spec:
    Â Â Â Â Â Â Â Â Â Â containers:
    Â Â Â Â Â Â Â Â Â Â - name: checker
    Â Â Â Â Â Â Â Â Â Â Â Â image: appropriate/curl
    Â Â Â Â Â Â Â Â Â Â Â Â args:
    Â Â Â Â Â Â Â Â Â Â Â Â - curl
    Â Â Â Â Â Â Â Â Â Â Â Â - -I
    Â Â Â Â Â Â Â Â Â Â Â Â - backend
    Â Â Â Â Â Â Â Â Â Â nodeSelector:
    Â Â Â Â Â Â Â Â Â Â Â Â cloud.google.com/gke-nodepool: "preemptible"
    Â Â Â Â Â Â Â Â Â Â tolerations:
    Â Â Â Â Â Â Â Â Â Â - key: preemptible
    Â Â Â Â Â Â Â Â Â Â Â Â operator: Equal
    Â Â Â Â Â Â Â Â Â Â Â Â value: "true"
    Â Â Â Â Â Â Â Â Â Â Â Â effect: NoSchedule
    Â Â Â Â Â Â Â Â Â Â restartPolicy: OnFailure
    ```

    è¯¥æ–‡ä»¶æœ‰ä¸€ä¸ªç”¨äºæ¯åˆ†é’Ÿè¿è¡Œ **curl -I åç«¯**åŠŸèƒ½çš„ **CronJob** å®šä¹‰ã€‚**èŠ‚ç‚¹é€‰æ‹©å™¨**è¡¨ç¤ºè°ƒåº¦ç¨‹åºå°†é€‰æ‹©åœ¨æ ‡ç­¾é”®ä¸º**cloud.google.com/gke-nodepool**ä¸”å€¼ä¸º**å¯æŠ¢å **çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ç„¶è€Œï¼Œç”±äºåœ¨å¯æŠ¢å çš„èŠ‚ç‚¹ä¸Šæœ‰æ±¡ç‚¹ï¼Œå®¹å¿ä¹Ÿè¢«æ·»åŠ ã€‚

    #### æ³¨æ„

    **cronjob.yaml** å¯åœ¨ GitHub:[https://GitHub . com/trainingypbackt/æ— æœåŠ¡å™¨æ¶æ„-with-Kubernetes/blob/master/lesson 05/activity 5/cron job . YAML](https://github.com/TrainingByPackt/Serverless-Architectures-with-Kubernetes/blob/master/Lesson05/Activity5/cronjob.yaml)ä¸Šè·å¾—ã€‚

5.  Deploy the CronJob with the following command:

    ```
    kubectl apply -f cronjob.yaml
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 5.32: CronJob creation ](img/C12607_05_32.jpg)

    ###### å›¾ 5.32:åˆ›å»ºæ ¸å¿ƒå·¥ä½œ

6.  Check the node assignments of the **CronJob** functions:

    ```
    kubectl get pods -o wide
    ```

    è¯¥å‘½ä»¤åˆ—å‡ºäº† pod åŠå…¶ç›¸åº”çš„èŠ‚ç‚¹ã€‚ä¸å‡ºæ‰€æ–™ï¼Œæ­£å¥½æœ‰ 10 ä¸ªåç«¯å®ä¾‹è¿è¡Œåœ¨**é«˜å†…å­˜**èŠ‚ç‚¹ä¸Šã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ 3 ä¸ªè¿è¡Œåœ¨**å¯æŠ¢å **èŠ‚ç‚¹ä¸Šçš„ CronJob å‡½æ•°å®ä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.33: Pod listing ](img/C12607_05_33.jpg)

    ###### å›¾ 5.33: Pod åˆ—è¡¨

7.  Check the logs of **CronJob** function instances:

    ```
    kubectl logs brand-checker-<ID> 
    ```

    #### æ³¨æ„

    å°† **< ID >** æ›¿æ¢ä¸º*æ­¥éª¤ 5* ä¸­çš„è±†èšåç§°ã€‚

    è¯¥å‡½æ•°çš„è¾“å‡ºæ˜¾ç¤ºäº†**å·æ›²**è¿æ¥åˆ° **nginx** å®ä¾‹çš„è½¨è¿¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.34: curl output ](img/C12607_05_34.jpg)

    ###### å›¾ 5.34:å·æ›²è¾“å‡º

8.  Clean the backend deployment and serverless functions:

    ```
    kubectl delete deployment/backend cronjob/backend-checker
    ```

    è¯¥å‘½ä»¤åˆ é™¤**åç«¯**éƒ¨ç½²å’Œ**åç«¯æ£€æŸ¥å™¨**å…‹éš†ä½œä¸šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.35: Cleanup ](img/C12607_05_35.jpg)

    ###### å›¾ 5.35:æ¸…ç†

9.  Remove the Kubernetes cluster if you do not need it anymore:

    ```
    gcloud container clusters delete serverless --zone us-central1-a 
    ```

    #### æ³¨æ„

    å¦‚æœæ‚¨çš„é›†ç¾¤æ­£åœ¨å¦ä¸€ä¸ªåŒºåŸŸè¿è¡Œï¼Œè¯·æ›´æ”¹å‘½ä»¤ä¸­çš„**åŒºåŸŸ**å‚æ•°ã€‚

    è¯¥å‘½ä»¤ä» GKE åˆ é™¤é›†ç¾¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

    ![Figure 5.36: Cluster removal ](img/C12607_05_36.jpg)

###### å›¾ 5.36:é›†ç¾¤ç§»é™¤

åœ¨æœ¬æ´»åŠ¨ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå®æ—¶ç”Ÿäº§é›†ç¾¤ä¸Šæ‰¿æ‹…äº†ç®¡ç†ä»»åŠ¡ã€‚åœ¨ Kubernetes é›†ç¾¤ä¸­åˆ›å»ºä¸åŒç±»å‹çš„èŠ‚ç‚¹å¹¶è¿è¡Œä¸€ç»„å¼‚æ„èŠ‚ç‚¹æœ‰åŠ©äºé™ä½æ•´ä¸ªé›†ç¾¤çš„æˆæœ¬ã€‚æ­¤å¤–ï¼Œè‡ªåŠ¨ç¼©æ”¾èƒ½å¤Ÿè‡ªåŠ¨æ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

åº”ç”¨çš„è‡ªåŠ¨ç¼©æ”¾å’Œè¿ç§»æ˜¯ç”Ÿäº§é›†ç¾¤ä¸Šæœ€å¸¸è§çš„æ“ä½œä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡èƒ½å¤Ÿä»¥æœ€å°‘çš„åœæœºæ—¶é—´å’Œæˆæœ¬å®ç°æ›´å¥½çš„æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œä¸ºæ‚¨çš„ç”Ÿäº§ç¯å¢ƒé€‰æ‹©çš„ Kubernetes å¹³å°ä¹Ÿåº”è¯¥æ»¡è¶³æ‚¨æ—¥å¸¸æ“ä½œçš„è¿™äº›è¦æ±‚ã€‚Kubernetes å’Œäº‘æä¾›å•†çš„åŠŸèƒ½å¯¹äºå®‰è£…ã€ç›‘æ§å’Œæ“ä½œäº‘ä¸­è¿è¡Œçš„åº”ç”¨è‡³å…³é‡è¦ã€‚

## 6.Kubernet å³å°†æ¨å‡ºçš„æ— æœåŠ¡å™¨åŠŸèƒ½

### æ´»åŠ¨ 6:åœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸­éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨

**è§£å†³æ–¹æ¡ˆ**

1.  é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç›®å½•æ¥å­˜å‚¨æ­¤æ´»åŠ¨çš„æ–‡ä»¶ï¼Œå¹¶å°†ç›®å½•æ›´æ”¹ä¸ºæ–°åˆ›å»ºçš„ç›®å½•:

    ```
    $ mkdir chapter-06-activity
    $ cd chapter-06-activity
    ```

2.  Create an application that can return the current date and time for the given timezone. We will be using PHP to write this function, but you can choose any language that you're comfortable with. Create an index.php file with the content given in step 1\.

    ç°åœ¨æˆ‘ä»¬éœ€è¦æ ¹æ®å®¹å™¨è¿è¡Œæ—¶å¥‘çº¦(https://Cloud . Google . com/Run/docs/reference/contract-contract)ä¸º Google Cloud Run åˆ›å»º Docker æ˜ åƒã€‚ä½¿ç”¨æ­¥éª¤ 2 ä¸­çš„å†…å®¹åˆ›å»ºä¸€ä¸ªåä¸º Dockerfile çš„æ–°æ–‡ä»¶ã€‚

3.  Once the Dockerfile is ready, we can build the Docker image. Replace **<your-gcp-project-name>** with the ID of your GCP project. Next, use the docker build command to build the Docker image. The **--tag** flag is used to tag the Docker image as per the **[HOSTNAME]/[GCP-PROJECT-ID]/[IMAGE-NAME]:[TAG]** format, as we will be pushing this to **Google Container Registry (GCR)** in the next step:

    ```
    $ export GCP_PROJECT=<your-gcp-project-name>
    $ docker build . --tag gcr.io/${GCP_PROJECT}/clock:v1.0
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 6.57: Building the Docker image ](img/C12607_06_57.jpg)

    ###### å›¾ 6.57:æ„å»º Docker æ˜ åƒ

4.  Next, we can push the docker image to GCR:

    ```
    $ docker push gcr.io/${GCP_PROJECT}/clock:v1.0
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 6.58: Pushing the Docker image ](img/C12607_06_58.jpg)

    ###### å›¾ 6.58:æ¨é€ Docker æ˜ åƒ

5.  Now we have a Docker image created and pushed to the registry. Now navigate to the GCP console and open the Cloud Run page. Click on the **CREATE SERVICE** button to create a new service with the following information:

    å®¹å™¨æ˜ åƒç½‘å€:**gcr.io/<æ‚¨çš„-GCP-project-id>/æ—¶é’Ÿ:v1.0**

    éƒ¨ç½²å¹³å°:äº‘è¿è¡Œ(å®Œå…¨ç®¡ç†)

    ä½ç½®:ä»å¯ç”¨é€‰é¡¹ä¸­é€‰æ‹©æ‚¨å–œæ¬¢çš„ä»»ä½•åœ°åŒº

    æœåŠ¡åç§°:æ—¶é’Ÿ

    è®¤è¯:**å…è®¸æœªç»è®¤è¯çš„è°ƒç”¨**

    è¯¥é¡µé¢å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 6.59: Creating a service ](img/C12607_06_59.jpg)

    ###### å›¾ 6.59:åˆ›å»ºæœåŠ¡

6.  Click on the **CREATE** button and you will be navigated to the Service details page:

    ![Figure 6.60: Service details ](img/C12607_06_60.jpg)

    ###### å›¾ 6.60:æœåŠ¡è¯¦æƒ…

7.  Open the provided URL from the Service details page. For me, this URL is **https://clock-awsve2jaoa-uc.a.run.app/**, but your URL will be different:

    ![Figure 6.61: Timezone error ](img/C12607_06_61.jpg)

    ###### å›¾ 6.61:æ—¶åŒºé”™è¯¯

8.  æˆ‘ä»¬æ”¶åˆ°æ­¤é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æä¾›æ—¶åŒºå‚æ•°ã€‚
9.  Let's invoke the URL again with the timezone parameter, **https://clock-awsve2jaoa-uc.a.run.app/?timezone=Europe/London**

    ![Figure 6.62: Output with timezone ](img/C12607_06_62.jpg)

###### å›¾ 6.62:å¸¦æ—¶åŒºçš„è¾“å‡º

åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨è°·æ­Œäº‘è¿è¡Œä¸ŠæˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªå®¹å™¨åŒ–çš„åº”ç”¨ï¼Œè¯¥åº”ç”¨å¯ä»¥åŸºäºæä¾›çš„**æ—¶åŒº**å€¼è¾“å‡ºå½“å‰æ—¥æœŸå’Œæ—¶é—´ã€‚

## 7.æ— åº“æœåŠ¡å™¨å’Œæ— åº“æœåŠ¡å™¨

### æ´»åŠ¨ 7:ç”¨æ— åº“å‘å¸ƒæ¶ˆæ¯åˆ° Slack

**è§£å†³æ–¹æ¡ˆ-æ¾å¼›è®¾ç½®**

1.  Visit https://slack.com/create to create a workspace. Enter your email address and click on Create:

    ![Figure 7.77: Creating a new workspace ](img/C12607_07_77.jpg)

    ###### å›¾ 7.77:åˆ›å»ºæ–°çš„å·¥ä½œç©ºé—´

2.  Now, you will receive a six-digit confirmation code to the email that you entered on the previous page. Enter the received code on the following page:

    ![Figure 7.78: Checking your email ](img/C12607_07_78.jpg)

    ###### å›¾ 7.78:æŸ¥çœ‹ä½ çš„ç”µå­é‚®ä»¶

3.  Add a suitable name here. This will be your workspace name:

    ![Figure 7.79: Adding a workspace name ](img/C12607_07_79.jpg)

    ###### å›¾ 7.79:æ·»åŠ å·¥ä½œç©ºé—´åç§°

4.  Add a suitable name here. This will be your Slack channel name:

    ![Figure 7.80: Adding a Slack channel name ](img/C12607_07_80.jpg)

    ###### å›¾ 7.80:æ·»åŠ å¤‡ç”¨é¢‘é“åç§°

    å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥è·³è¿‡ä»¥ä¸‹éƒ¨åˆ†:

    ![Figure 7.81: Filling in further details or choosing to skip ](img/C12607_07_81.jpg)

    ###### å›¾ 7.81:å¡«å†™æ›´å¤šç»†èŠ‚æˆ–é€‰æ‹©è·³è¿‡

5.  Now your Slack channel is ready. Click on **See Your Channel in Slack**, as shown in the following screenshot:

    ![Figure 7.82: Seeing the new Slack channel ](img/C12607_07_82.jpg)

    ###### å›¾ 7.82:æŸ¥çœ‹æ–°çš„æ¾å¼›é€šé“

    ç‚¹å‡»åï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°æˆ‘ä»¬çš„é¢‘é“å¦‚ä¸‹:

    ![Figure 7.83: Your new Slack channel ](img/C12607_07_83.jpg)

    ###### å›¾ 7.83:æ‚¨çš„æ–°æ¾å¼›é€šé“

6.  Now we are going to add an Incoming Webhook app to our slack. From the left menu, select Add apps under the Apps section:

    ![Figure 7.84: Adding apps under the Apps section ](img/C12607_07_84.jpg)

    ###### å›¾ 7.84:åœ¨åº”ç”¨éƒ¨åˆ†ä¸‹æ·»åŠ åº”ç”¨

7.  Enter **Incoming Webhooks** in the search field and click on **Install** for the Incoming Webhook app:

    ![Figure 7.85: Browsing apps ](img/C12607_07_85.jpg)

    ###### å›¾ 7.85:æµè§ˆåº”ç”¨

8.  Click on **Add Configuration**:

    ![Figure 7.86: Adding configuration ](img/C12607_07_86.jpg)

    ###### å›¾ 7.86:æ·»åŠ é…ç½®

9.  Click on **Add Incoming WebHooks Integration**:

    ![Figure 7.87: Adding incoming webhooks ](img/C12607_07_87.jpg)

    ###### å›¾ 7.87:æ·»åŠ ä¼ å…¥çš„ç½‘ç»œé’©å­

10.  ä¿å­˜ç½‘é¡µæŒ‚é’©ç½‘å€ã€‚å½“æˆ‘ä»¬ç¼–å†™ Kube less å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦è¿™ä¸ªã€‚
11.  ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå‡½æ•°å¹¶éƒ¨ç½²å®ƒã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º requirements.txt æ–‡ä»¶ï¼Œå®ƒæŒ‡å®šäº†æˆ‘ä»¬éœ€è¦ä¸ºå‡½æ•°çš„è¿è¡Œæ—¶å®‰è£…çš„ä¾èµ–é¡¹ã€‚è¿™äº›æ˜¯æˆ‘ä»¬æˆåŠŸè¿è¡ŒåŠŸèƒ½æ‰€éœ€çš„é™„åŠ æ¨¡å—ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¯·æ±‚åŒ…å‘ Slack webhook ç«¯ç‚¹å‘é€ HTTP POST è¯·æ±‚:

    ```
    Requests==2.22.0
    ```

**æ´»åŠ¨è§£å†³æ–¹æ¡ˆ**

1.  æŒ‰å¦‚ä¸‹æ–¹å¼åˆ›å»ºå‡½æ•°ã€‚

    ```
    import json
    import requests
    def main(event, context):
    Â Â Â Â webhook_url = 'YOUR_INCOMMING_WEBHOOK_URL'
    Â Â Â Â response = requests.post(
    Â Â Â Â Â Â Â Â webhook_url, data=json.dumps(event['data']),
    Â Â Â Â Â Â Â Â headers={'Content-Type': 'application/json'}
    Â Â Â Â )
    Â Â Â Â if response.status_code == 200:
    Â Â Â Â Â Â Â Â return "Your message successfully sent to Slack"
    Â Â Â Â else:
    Â Â Â Â Â Â Â Â return "Error while sending your message to Slack: " + response.get('error')
    ```

2.  Deploy the function:

    ```
    $ kubeless function deploy slack --runtime python3.6 \
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --from-file slack.py \
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --handler slack.main \
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --dependencies requirements.txt
    ```

    éƒ¨ç½²è¯¥å‡½æ•°å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡º:

    ![Figure 7.88: Deploying the function ](img/C12607_07_88.jpg)

    ###### å›¾ 7.88:éƒ¨ç½²åŠŸèƒ½

    åœ¨éƒ¨ç½² slack å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å°†ä¸Šä¸€æ­¥åˆ›å»ºçš„ requirements.txt æ–‡ä»¶ä½œä¸ºä¾èµ–é¡¹ä¼ é€’ã€‚è¿™å°†ç¡®ä¿ Kubeless è¿è¡Œæ—¶åŒ…å«å‡½æ•°æ‰§è¡Œæ‰€éœ€çš„ Python åŒ…ã€‚

3.  Invoke the kubeless function:

    ```
    $ kubeless function call slack --data '{"username": "kubeless-bot", "text": "Welcome to Serverless Architectures with Kubeless !!!"}'
    ```

    è¿™å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡º:

    ![Figure 7.89: Invoking the function ](img/C12607_07_89.jpg)

    ###### å›¾ 7.89:è°ƒç”¨å‡½æ•°

4.  Go to your Slack workspace and verify that the message was successfully posted to the Slack channel:

    ![Figure 7.90: Verifying whether the message was successfully posted ](img/C12607_07_90.jpg)

###### å›¾ 7.90:éªŒè¯æ¶ˆæ¯æ˜¯å¦æˆåŠŸå‘å¸ƒ

åœ¨æœ¬æ´»åŠ¨ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª Slack ç©ºé—´ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªä¼ å…¥çš„ webhookã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºå¹¶éƒ¨ç½²äº†ä¸€ä¸ªæ— åº“å‡½æ•°ï¼Œå®ƒå¯ä»¥å°†æ¶ˆæ¯å‘å¸ƒåˆ° Slack é€šé“ã€‚

## 8.ApacheOpen æ™¶é¡»ç®€ä»‹

### æ´»åŠ¨ 8:é€šè¿‡ç”µå­é‚®ä»¶æ¥æ”¶æ¯æ—¥å¤©æ°”æ›´æ–°

åˆ›å»ºå¼€æ”¾å¤©æ°”å’Œå‘é€ç½‘æ ¼å¸æˆ·çš„æ­¥éª¤:

1.  Create an **OpenWeather** account at [https://home.openweathermap.org/users/sign_up](https://home.openweathermap.org/users/sign_up):

    ![Figure 8.72: Creating an OpenWeather account ](img/C12607_08_72.jpg)

    ###### å›¾ 8.72:åˆ›å»ºä¸€ä¸ªå¼€æ”¾å¤©æ°”è´¦æˆ·

2.  Once you have signed up to **OpenWeather**, an API key will be generated automatically for you. Go to the **API keys** tab ([https://home.openweathermap.org/api_keys](https://home.openweathermap.org/api_keys)) and save the API key because this key is required to fetch the data from OpenWeather API:

    ![Figure 8.73: OpenWeather API key ](img/C12607_08_73.jpg)

    ###### å›¾ 8.73:å¼€æ”¾å¤©æ°”åº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥

3.  Test the **OpenWeather** API using **https://api.openweathermap.org/data/2.5/weather?q=London&appid=<YOUR-API-KEY>** in a web browser. Please note that you need to replace **<YOUR-API-KEY>** with your API Key from step 2:

    #### æ³¨æ„

    æ¿€æ´»åº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚ç­‰å¾…å‡ åˆ†é’Ÿï¼Œå¦‚æœæ”¶åˆ°**æ— æ•ˆçš„ API å¯†é’¥**ï¼Œè¯·é‡è¯•ã€‚è¯¦æƒ…è¯·è§[http://openweathermap.org/faq#error401](http://openweathermap.org/faq#error401)ã€‚è°ƒç”¨ç½‘å€æ—¶å‡ºé”™ã€‚

    ![Figure 8.74: Invoking OpenWeather API ](img/C12607_08_74.jpg)

    ###### å›¾ 8.74:è°ƒç”¨å¼€æ”¾å¤©æ°”åº”ç”¨ç¼–ç¨‹æ¥å£

4.  Create a **SendGrid** account at [https://signup.sendgrid.com/](https://signup.sendgrid.com/).

    å®ƒåº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.75: Creating a SendGrid account ](img/C12607_08_75.jpg)

    ###### å›¾ 8.75:åˆ›å»ºä¸€ä¸ªå‘é€ç½‘æ ¼å¸æˆ·

5.  Go to **Settings** > **API Keys** and click on the **Create API Key** button:

    ![Figure 8.76: API key page in SendGrid ](img/C12607_08_76.jpg)

    ###### å›¾ 8.76:å‘é€ç½‘æ ¼ä¸­çš„åº”ç”¨ç¼–ç¨‹æ¥å£å…³é”®é¡µ

6.  Provide a name in the **API Key Name** field, select the **Full Access** radio button, and click on the **Create & View** button to create an API key with full access:

    ![Figure 8.77: Generating an API key in SendGrid ](img/C12607_08_77.jpg)

    ###### å›¾ 8.77:åœ¨å‘é€ç½‘æ ¼ä¸­ç”Ÿæˆåº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥

7.  Once the key is generated, copy the API key and save it somewhere safe because you will see this key only once:

    ![Figure 8.78: Generated API key in SendGrid  ](img/C12607_08_78.jpg)

###### å›¾ 8.78:åœ¨å‘é€ç½‘æ ¼ä¸­ç”Ÿæˆçš„åº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥

**æ´»åŠ¨è§£å†³æ–¹æ¡ˆ**

1.  ä½¿ç”¨*æ­¥éª¤ 3* ä¸­æä¾›çš„åŠŸèƒ½ä»£ç åˆ›å»º **get-weather.js** åŠŸèƒ½ã€‚å°†**<OPEN _ WEATHER _ API _ KEY>**æ›¿æ¢ä¸º*æ­¥éª¤ 1* ä¸­ä¿å­˜çš„ API å¯†é’¥ã€‚
2.  Create the action named **getWeather** with the **get-weather.js** function created in the preceding step and provide the default value of the **cityName** parameter as **London**:

    ```
    $ wsk action create getWeather get-weather.js --param cityName London
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.79: Creating the getWeather action  ](img/C12607_08_79.jpg)

    ###### å›¾ 8.79:åˆ›å»º getWeather æ“ä½œ

3.  Verify that the action is working as expected by invoking the action:

    ```
    $ wsk action invoke getWeather --result
    ```

    ![Figure 8.80: Invoking the getWeather action ](img/C12607_08_80.jpg)

    ###### å›¾ 8.80:è°ƒç”¨ getWeather æ“ä½œ

4.  Now we can create the action to send emails (we will be using the API key generated with SendGrid). We will be using the **sendgrid** module for this function. First, we need to create a directory to store the function code and the dependencies:

    ```
    $ mkdir send-email
    $ cd send-email
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.81: Creating the send-mail directory ](img/C12607_08_81.jpg)

    ###### å›¾ 8.81:åˆ›å»ºå‘é€é‚®ä»¶ç›®å½•

5.  Run the **npm init** command by accepting the default parameters:

    ```
    $ npm init
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.82: npm init ](img/C12607_08_82.jpg)

    ###### å›¾ 8.82: npm init

6.  Install the **sendgrid** **npm** package, which is required for the function:

    ```
    $ npm install sendgrid -save
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.83: Adding the sendgrid dependency package ](img/C12607_08_83.jpg)

    ###### å›¾ 8.83:æ·»åŠ  sendgrid ä¾èµ–åŒ…

7.  ä½¿ç”¨*æ­¥éª¤ 4* ä¸­æä¾›çš„åŠŸèƒ½ä»£ç åˆ›å»º **index.js** æ–‡ä»¶ã€‚å°† **<å‘é€ _ ç½‘æ ¼ _ åº”ç”¨ç¼–ç¨‹æ¥å£ _ å¯†é’¥>** æ›¿æ¢ä¸ºå¯†é’¥ï¼Œè¯¥å¯†é’¥æ˜¯åœ¨åˆ›å»ºå‘é€ç½‘æ ¼å¸æˆ·æ—¶ä¿å­˜çš„ã€‚åŒæ ·ï¼Œæ›¿æ¢ **< TO_EMAIL >** æ¥æ”¶å¤©æ°”æ•°æ®ï¼Œæ›¿æ¢ **< FROM_EMAIL >** ç”¨ä½ çš„é‚®ç®±åœ°å€å‘é€å¤©æ°”æ•°æ®ã€‚
8.  ç”¨æ‰€æœ‰ä¾èµ–é¡¹å‹ç¼©ä»£ç :

    ```
    $ zip -r send-email.zip *
    ```

9.  Now we can create an action named **sendEmail** using **send-email.zip**:

    ```
    $ wsk action create sendEmail send-email.zip --kind nodejs:default
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.84: Creating the sendEmail action ](img/C12607_08_84.jpg)

    ###### å›¾ 8.84:åˆ›å»ºå‘é€ç”µå­é‚®ä»¶æ“ä½œ

10.  Verify that the **sendEmail** action is working as expected:

    #### æ³¨æ„

    è¯·åŠ¡å¿…æ£€æŸ¥æ‚¨çš„åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼Œå› ä¸ºç”µå­é‚®ä»¶å®¢æˆ·ç«¯å¯èƒ½å·²å°†å…¶å½’ç±»ä¸ºåƒåœ¾é‚®ä»¶ã€‚

    ```
    $ wsk action invoke sendEmail --param message "Test Message" â€“result
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.85: Invoking the sendEmail action ](img/C12607_08_85.jpg)

    ###### å›¾ 8.85:è°ƒç”¨å‘é€ç”µå­é‚®ä»¶æ“ä½œ

11.  ä½¿ç”¨*æ­¥éª¤ 5* ä¸­æä¾›çš„åŠŸèƒ½ä»£ç åˆ›å»º**æ ¼å¼-å¤©æ°”-æ•°æ®. js** åŠŸèƒ½ã€‚
12.  Create the action named **formatWeatherData** with the **format-weather-data.js** function created in the preceding step:

    ```
    $ wsk action create formatWeatherData format-weather-data.js
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.86: Creating the formatWeatherData action ](img/C12607_08_86.jpg)

    ###### å›¾ 8.86:åˆ›å»ºæ ¼å¼åŒ–å¤©æ°”æ•°æ®åŠ¨ä½œ

13.  Create a sequence named **weatherMailSender** by combining the **getWeather**, **formatWeatherData**, and **sendEmail** actions:

    ```
    $ wsk action create weatherMailSender --sequence getWeather,formatWeatherData,sendEmail
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.87: Creating the weatherMailSender action sequence ](img/C12607_08_87.jpg)

    ###### å›¾ 8.87:åˆ›å»ºå¤©æ°”é‚®ä»¶å‘é€è€…åŠ¨ä½œåºåˆ—

14.  Invoke the **weatherMailSender** sequence:

    ```
    $ wsk action invoke weatherMailSender --result
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.88: Invoking the weatherMailSender action sequence ](img/C12607_08_88.jpg)

    ###### å›¾ 8.88:è°ƒç”¨å¤©æ°”é‚®ä»¶å‘é€è€…åŠ¨ä½œåºåˆ—

15.  Check the mail account that you added as **<TO_EMAIL>** (check the spam folder). Check the status of email delivery at [https://app.sendgrid.com/email_activity](https://app.sendgrid.com/email_activity).

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.89: Received email from the weatherMailSender action sequence ](img/C12607_08_89.jpg)

    ###### å›¾ 8.89:ä»å¤©æ°”é‚®ä»¶å‘é€è€…æ”¶åˆ°çš„ç”µå­é‚®ä»¶åŠ¨ä½œåºåˆ—

16.  æœ€åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºè§¦å‘å™¨å’Œè§„åˆ™æ¥è°ƒç”¨æ¯å¤©ä¸Šåˆ 8 ç‚¹çš„åºåˆ—ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»º**å¤©æ°”é‚®ä»¶å‘é€å™¨è§¦å‘ç¨‹åº**ï¼Œè¯¥ç¨‹åºå°†åœ¨æ¯å¤©ä¸Šåˆ 8:00:

    ```
    $ wsk trigger create weatherMailSenderCronTrigger \
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --feed /whisk.system/alarms/alarm \
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --param cron "0 8 * * *" 
    ok: invoked /whisk.system/alarms/alarm with id cf1af9989a7a46a29af9989a7ad6a28c
    {
    Â Â Â Â "activationId": "cf1af9989a7a46a29af9989a7ad6a28c",
    Â Â Â Â "annotations": [
    Â Â Â Â Â Â Â Â {
    Â Â Â Â Â Â Â Â Â Â Â Â "key": "path",
    Â Â Â Â Â Â Â Â Â Â Â Â "value": "whisk.system/alarms/alarm"
    Â Â Â Â Â Â Â Â },
    Â Â Â Â Â Â Â Â {
    Â Â Â Â Â Â Â Â Â Â Â Â "key": "waitTime",
    Â Â Â Â Â Â Â Â Â Â Â Â "value": 66
    Â Â Â Â Â Â Â Â },
    Â Â Â Â Â Â Â Â {
    Â Â Â Â Â Â Â Â Â Â Â Â "key": "kind",
    Â Â Â Â Â Â Â Â Â Â Â Â "value": "nodejs:10"
    Â Â Â Â Â Â Â Â },
    Â Â Â Â Â Â Â Â {
    Â Â Â Â Â Â Â Â Â Â Â Â "key": "timeout",
    Â Â Â Â Â Â Â Â Â Â Â Â "value": false
    Â Â Â Â Â Â Â Â },
    Â Â Â Â Â Â Â Â {
    Â Â Â Â Â Â Â Â Â Â Â Â "key": "limits",
    Â Â Â Â Â Â Â Â Â Â Â Â "value": {
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "concurrency": 1,
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "logs": 10,
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "memory": 256,
    Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "timeout": 60000
    Â Â Â Â Â Â Â Â Â Â Â Â }
    Â Â Â Â Â Â Â Â }
    Â Â Â Â ],
    Â Â Â Â "duration": 162,
    Â Â Â Â "end": 1565457634929,
    Â Â Â Â "logs": [],
    Â Â Â Â "name": "alarm",
    Â Â Â Â "namespace": "sathsara89@gmail.com_dev",
    Â Â Â Â "publish": false,
    Â Â Â Â "response": {
    Â Â Â Â Â Â Â Â "result": {
    Â Â Â Â Â Â Â Â Â Â Â Â "status": "success"
    Â Â Â Â Â Â Â Â },
    Â Â Â Â Â Â Â Â "status": "success",
    Â Â Â Â Â Â Â Â "success": true
    Â Â Â Â },
    Â Â Â Â "start": 1565457634767,
    Â Â Â Â "subject": "sathsara89@gmail.com",
    Â Â Â Â "version": "0.0.152"
    }
    ok: created trigger weatherMailSenderCronTrigger
    ```

    è§¦å‘
17.  Then, we will create a rule named **weatherMailSenderCronRule** to connect the trigger (**weatherMailSenderCronTrigger**) and action (**weatherMailSender**):

    ```
    $ wsk rule create weatherMailSenderCronRule weatherMailSenderCronTrigger weatherMailSender
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 8.90: Creating weatherMailSenderCronRule ](img/C12607_08_90.jpg)

###### å›¾ 8.90:åˆ›å»ºå¤©æ°”é‚®ä»¶å‘é€å¾ªç¯è§„åˆ™

å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œæ‚¨åº”è¯¥ä¼šåœ¨æ¯å¤©ä¸Šåˆ 8 ç‚¹æ”¶åˆ°ä¸€å°ç”µå­é‚®ä»¶ï¼Œå‘é€åˆ°æŒ‡å®šçš„ç”µå­é‚®ä»¶åœ°å€ï¼Œå…¶ä¸­åŒ…å«æ‰€è¯·æ±‚åŸå¸‚çš„å¤©æ°”æ•°æ®ã€‚

## 9.ä½¿ç”¨ OpenFaaS å®ç°æ— æœåŠ¡å™¨

### æ´»åŠ¨ 9: OpenFaaS è¡¨å•å¤„ç†å™¨

**è§£å†³æ–¹æ¡ˆ**

1.  é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªå‘é€ç½‘æ ¼å¸æˆ·å¹¶ç”Ÿæˆä¸€ä¸ªåº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥ã€‚æ‚¨å¯ä»¥ä½¿ç”¨åœ¨æ´»åŠ¨*ç¬¬ 08 ç« ï¼ŒApacheopen æ™¶é¡»ç®€ä»‹*ä¸­åˆ›å»ºçš„ç›¸åŒ API å¯†é’¥ã€‚è¯·å‚è€ƒ*ç¬¬ 08 ç« â€œApache OpenWhisk ç®€ä»‹â€*æ´»åŠ¨ä¸­çš„æ­¥éª¤ 4-7ï¼Œäº†è§£å¦‚ä½•åˆ›å»ºå‘é€ç½‘æ ¼å¸æˆ·å’Œç”Ÿæˆåº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥ã€‚
2.  Create an OpenFaaS function named contact-form using the python3 template. This will be the frontend of the contact form:

    ```
    $ faas-cli new contact-form --lang=python3
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 9.59: Creating the contact-form function ](img/C12607_09_591.jpg)

    ###### å›¾ 9.59:åˆ›å»ºè”ç³»äººè¡¨å•åŠŸèƒ½

3.  Create a new directory named html inside the contact-form directory to store the HTML files:

    ```
    $ mkdir contact-form/html
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 9.60: Creating the HTML folder ](img/C12607_09_601.jpg)

    ###### å›¾ 9.60:åˆ›å»º HTML æ–‡ä»¶å¤¹

4.  ä½¿ç”¨æ­¥éª¤ 2 ä¸­æä¾›çš„ä»£ç åœ¨è”ç³»äººè¡¨å•/html æ–‡ä»¶å¤¹ä¸­åˆ›å»º contact-us.html æ–‡ä»¶ã€‚
5.  æ›´æ–°è”ç³»äººè¡¨å•æ–‡ä»¶å¤¹ä¸­çš„**å¤„ç†ç¨‹åº. py** Python æ–‡ä»¶ã€‚è¯¥ Python å‡½æ•°å°†è¯»å–**contact-us.html**æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶ä½œä¸ºå‡½æ•°å“åº”è¿”å›:

    ```
    import os

    def handle(req):
    Â Â Â Â current_directory = os.path.dirname(__file__)
    Â Â Â Â html_file_path = os.path.join(current_directory, 'html', 'contact-us.html')
    Â Â Â Â with(open(html_file_path, 'r')) as html_file:
    Â Â Â Â Â Â Â Â html = html_file.read()

    Â Â Â Â return html
    ```

6.  æ›´æ–°å‡½æ•°å®šä¹‰( **contact-form.yml** )æ–‡ä»¶ï¼Œå°† content_type æŒ‡å®šä¸º **text/html** ï¼Œè§£é‡Šå¦‚ä¸‹ä»£ç :

    ```
    version: 1.0
    provider:
    Â Â name: openfaas
    Â Â gateway: http://192.168.99.100:31112
    functions:
    Â Â contact-form:
    Â Â Â Â lang: python3
    Â Â Â Â handler: ./contact-form
    Â Â Â Â image: sathsarasa/contact-form:latest
    Â Â Â Â environment:
    Â Â Â Â Â Â content_type: text/html
    ```

7.  Build, push, and deploy the contact-form function:

    ```
    $Â Â faas-cli up -f contact-form.yml
    ```

    è¯¥å‘½ä»¤çš„è¾“å‡ºåº”è¯¥å¦‚ä¸‹:

    ```
    [0] > Building contact-form.
    Clearing temporary build folder: ./build/contact-form/
    Preparing ./contact-form/ ./build/contact-form//function
    Building: sathsarasa/contact-form:latest with python3 template. Please wait..
    Sending build context to Docker daemonÂ Â 14.34kB
    ...
    Successfully built 6c008c91f0bb
    Successfully tagged sathsarasa/contact-form:latest
    Image: sathsarasa/contact-form:latest built.
    [0] < Building contact-form done.
    [0] worker done.
    [0] > Pushing contact-form [sathsarasa/contact-form:latest].
    The push refers to repository [docker.io/sathsarasa/contact-form]
    ...
    latest: digest: sha256:b4f0a4f474af0755b53acb6a1c0ce26e0f91a9a893bb8bfc78501cab267d823e size: 4282
    [0] < Pushing contact-form [sathsarasa/contact-form:latest] done.
    [0] worker done.
    Deploying: contact-form.
    WARNING! Communication is not secure, please consider using HTTPS. Letsencrypt.org offers free SSL/TLS certificates.
    Deployed. 202 Accepted.
    URL: http://192.168.99.100:31112/function/contact-form
    ```

8.  Create the second OpenFaaS function named form-processor using the python3 template. This will be the backend of the contact form:

    ```
    $ faas-cli new form-processor --lang=python3
    ```

    è¾“å‡ºåº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 9.61: Creating the form-processor function ](img/C12607_09_61.jpg)

    ###### å›¾ 9.61:åˆ›å»ºè¡¨å•å¤„ç†å‡½æ•°

9.  æ›´æ–°è¡¨å•å¤„ç†å™¨æ–‡ä»¶å¤¹ä¸­çš„**å¤„ç†ç¨‹åº. py** Python æ–‡ä»¶ã€‚è¿™ä¸ª Python å‡½æ•°æ‰§è¡Œæ¥æ”¶è¾“å…¥åˆ°â€œè”ç³»æˆ‘ä»¬â€è¡¨å•ä¸­çš„ç”µå­é‚®ä»¶ã€å§“åå’Œæ¶ˆæ¯å‚æ•°ï¼Œæ ¼å¼åŒ–è¦å‘é€çš„ç”µå­é‚®ä»¶æ­£æ–‡ï¼Œä½¿ç”¨ SendGrid å‘é€ç”µå­é‚®ä»¶ï¼Œå¹¶å°†ç”µå­é‚®ä»¶å‘é€çŠ¶æ€ä½œä¸ºå‡½æ•°å“åº”è¿”å›ã€‚
10.  å°†<send_grid_api_key>æ›¿æ¢ä¸ºæ­¥éª¤ 1 ä¸­ä¿å­˜çš„å‘é€ç½‘æ ¼åº”ç”¨ç¼–ç¨‹æ¥å£å¯†é’¥ï¼Œå°†<to_email>æ›¿æ¢ä¸ºæ¥æ”¶è”ç³»æˆ‘ä»¬è¡¨å•æ•°æ®çš„ç”µå­é‚®ä»¶åœ°å€:

    ```
    Â Â Â Â Â import json
    from sendgrid import SendGridAPIClient
    from sendgrid.helpers.mail import Mail
    def handle(req):

    Â Â Â Â SENDGRID_API_KEY = '<SEND_GRID_API_KEY>'
    Â Â Â Â TO_EMAIL = '<TO_EMAIL>'
    Â Â Â Â EMAIL_SUBJECT = 'New Message from OpenFaaS Contact Form'

    Â Â Â Â json_req = json.loads(req)
    Â Â Â Â email = json_req["email"]
    Â Â Â Â name = json_req["name"]
    Â Â Â Â message = json_req["message"]
    Â Â Â Â email_body = '<strong>Name: </strong>' + name + '<br><br> <strong>Email: </strong>' + email + '<br><br> <strong>Message: </strong>' + message

    Â Â Â Â email_object = Mail(
    Â Â Â Â Â Â Â Â from_email= email,
    Â Â Â Â Â Â Â Â to_emails=TO_EMAIL,
    Â Â Â Â Â Â Â Â subject=EMAIL_SUBJECT,
    Â Â Â Â Â Â Â Â html_content=email_body)

    Â Â Â Â try:
    Â Â Â Â Â Â Â Â sg = SendGridAPIClient(SENDGRID_API_KEY)
    Â Â Â Â Â Â Â Â response = sg.send(email_object)
    Â Â Â Â Â Â Â Â sendingStatus = "Message sent successfully"
    Â Â Â Â except Exception as e:
    Â Â Â Â Â Â Â Â sendingStatus = "Message sending failed"

    Â Â Â Â return sendingStatus
    ```</to_email></send_grid_api_key> 
11.  åœ¨è¡¨å•å¤„ç†å™¨å‡½æ•°çš„è¡¨å•å¤„ç†å™¨/requirements.txt ä¸­æ·»åŠ  sendgrid æ¨¡å—ä½œä¸ºä¾èµ–é¡¹:

    ```
    sendgrid
    ```

12.  åœ¨ form-processor.yml ä¸­å¢åŠ è¶…æ—¶(read_timeoutã€write_timeout å’Œ exec_timeout)å€¼ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º:

    ```
    version: 1.0
    provider:
    Â Â name: openfaas
    Â Â gateway: http://192.168.99.100:31112
    functions:
    Â Â form-processor:
    Â Â Â Â lang: python3
    Â Â Â Â handler: ./form-processor
    Â Â Â Â image: sathsarasa/form-processor:latest
    Â Â Â Â environment:
    Â Â Â Â Â Â read_timeout: 20
    Â Â Â Â Â Â write_timeout: 20
    Â Â Â Â Â Â exec_timeout: 20
    ```

13.  Build, deploy, and push the form-processor function:

    ```
    $Â Â faas-cli up -f form-processor.yml
    ```

    è¯¥å‘½ä»¤çš„è¾“å‡ºåº”è¯¥å¦‚ä¸‹:

    ```
    [0] > Building form-processor.
    Clearing temporary build folder: ./build/form-processor/
    Preparing ./form-processor/ ./build/form-processor//function
    Building: sathsarasa/form-processor:latest with python3 template. Please wait..
    Sending build context to Docker daemonÂ Â 10.24kB
    ...
    Successfully built 128245656019
    Successfully tagged sathsarasa/form-processor:latest
    Image: sathsarasa/form-processor:latest built.
    [0] < Building form-processor done.
    [0] worker done.
    [0] > Pushing form-processor [sathsarasa/form-processor:latest].
    The push refers to repository [docker.io/sathsarasa/form-processor]
    ...
    latest: digest: sha256:c700592a3a7f16875c2895dbfa41bd269631780d9195290141c245bec93a2257 size: 4286
    [0] < Pushing form-processor [sathsarasa/form-processor:latest] done.
    [0] worker done.
    Deploying: form-processor.
    WARNING! Communication is not secure, please consider using HTTPS. Letsencrypt.org offers free SSL/TLS certificates.
    Deployed. 202 Accepted.
    URL: http://192.168.99.100:31112/function/form-processor
    ```

14.  Open the **Contact Us** form by opening the URL in a web browser:

    **http://192 . 168 . 99 . 100:31112/åŠŸèƒ½/è”ç³»äºº-è¡¨å•**

    è”ç³»äººè¡¨å•åº”å¦‚ä¸‹æ‰€ç¤º:

    ![Figure 9.62: Invoking the Contact Us form ](img/C12607_09_62.jpg)

    ###### å›¾ 9.62:è°ƒç”¨è”ç³»æˆ‘ä»¬è¡¨å•

15.  Fill in the form and then submit the form, as shown in the following figure:

    ![Figure 9.63: Submitting the contact us form ](img/C12607_09_63.jpg)

    ###### å›¾ 9.63:æäº¤è”ç³»æˆ‘ä»¬è¡¨å•

16.  æ£€æŸ¥æ‚¨åœ¨æ­¥éª¤ 9 ä¸­æä¾›çš„ç”µå­é‚®ä»¶å¸æˆ· **< TO_EMAIL >** ä»¥éªŒè¯ç”µå­é‚®ä»¶çš„å‘é€:

![Figure 9.64: Verifying email delivery ](img/C12607_09_64.jpg)

###### å›¾ 9.64:éªŒè¯ç”µå­é‚®ä»¶ä¼ é€’